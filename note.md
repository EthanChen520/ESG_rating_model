# 一、主要程序

## **==1、ahp 计算：ahp_analysis_main.py==**

### **核心目标 ​**​

​**​ 自动化计算 ESG 指标体系的 AHP 权重 ​**​，并输出包含权重值、一致性检验结果、指标层级的完整分析表。

---

### **输入与输出 ​**​

#### ​**​ 输入数据 ​**​

- ​**​ 判断矩阵文件夹 ​**​

  - 包含多个 CSV 文件，文件名反映指标层级（如`ESG.csv`、`E.csv`、`E1.csv`等）

  - 每个 CSV 文件存储一个判断矩阵（方阵），行列对应同级指标的两两比较值。

- ​**​ESG 指标元数据表 ​**​

  - 包含字段：`指标名称`、`指标code`，用于关联权重结果与业务编码。

#### ​**​ 输出结果 ​**​

- ​**​AHP 分析结果表 ​**​

  - 字段：`上级指标`、`指标名称`、`权重`、`一致性比率（CR）`、`指标等级`、`指标code`。

---

### **处理流程 ​**​

#### ​**​ 步骤 1：初始化与数据加载 ​**​

- 读取 ESG 指标元数据表（`ESG_index.csv`），建立指标名称与 code 的映射关系。

- 初始化空列表用于存储所有 AHP 计算结果。

#### ​**​ 步骤 2：递归遍历判断矩阵文件 ​**​

- 遍历指定文件夹（含子文件夹）中的所有 CSV 文件。

- 对每个文件检查是否为方阵：

  - ​**​ 是 ​**​：进入 AHP 计算流程。

  - ​**​ 否 ​**​：跳过并记录警告。

#### ​**​ 步骤 3：AHP 计算（单文件处理）​**​

1.  ​**​ 特征分解 ​**​

    - 计算矩阵的特征值和特征向量。

    - 取最大特征值对应的特征向量（绝对值处理）。

    - 归一化得到权重向量。

2.  ​**​ 一致性检验 ​**​

    - 计算一致性指标（CI）和随机一致性比率（CR）。

    - 使用标准 RI 值表，根据矩阵阶数 n 自动匹配 RI 值。

    - CR \= CI / RI，若 CR ≥ 0.1 需人工复核逻辑。

3.  ​**​ 确定指标层级 ​**​

    - 根据文件名自动划分等级：

      - `ESG.csv` → 等级 0（顶层）

      - `E.csv`/`S.csv`/`G.csv` → 等级 1（支柱层）

      - 短文件名（如`E1.csv`） → 等级 2（二级指标）

      - 长文件名（如`E11.csv`） → 等级 3（三级/四级指标）

4.  ​**​ 存储结果 ​**​

    - 记录当前文件的`上级指标`（文件名）、`指标名称`、`权重`、`CR`、`指标等级`。

#### ​**​ 步骤 4：结果合并与补充 ​**​

- 将 AHP 结果与 ESG 元数据表左连接，补充`指标code`字段。

- 特殊处理支柱层指标（E/S/G）的`指标code`，直接使用名称填充。

#### ​**​ 步骤 5：输出分析表 ​**​

- 将最终结果保存为 CSV 文件，字段按固定顺序排列。

---

### **关键逻辑说明 ​**​

|      ​**​ 模块 ​**​      |                               ​**​ 规则 ​**​                               |
| :----------------------: | :------------------------------------------------------------------------: |
|    ​**​ 权重计算 ​**​    |         基于主特征向量归一化，保留 2 位小数百分比（如`25.00%`）。          |
|    ​**​ 层级判定 ​**​    | 文件名长度决定等级：1 字符 → 等级 1，2-3 字符 → 等级 2，≥4 字符 → 等级 3。 |
|   ​**​ 一致性检验 ​**​   |             仅对 n≥3 的矩阵计算 CR；n\=1 或 2 时 CR 强制为 0。             |
| ​**​ 指标 code 关联 ​**​ |    优先使用元数据表匹配，支柱层（E/S/G）无匹配时直接使用名称作为 code。    |

---

### **异常处理 ​**​

- ​**​ 非方阵文件 ​**​：跳过处理并提示警告。

- ​**​ 空文件/无效数据 ​**​：抛出异常终止流程。

- ​**​CR 值超标 ​**​：不中断流程，但需人工后续检查。

---

### ​**​ 扩展性设计 ​**​

- ​**​ 动态层级支持 ​**​：通过文件名长度自动适应新增层级（如四级指标可命名为`E111.csv`）。

- ​**​ 灵活路径配置 ​**​：输入文件夹和输出路径可通过变量修改。

## ==2、layer4_entropy_weight==

### 1. 核心功能

该代码模块用于计算 ESG 指标体系第 4 层指标的熵权法权重，并将结果结构化输出。

### 2. 输入输出

#### 输入数据：

- `ESG_index.csv`：指标元数据表（包含指标层级关系）

- `ESG4.csv`：第 4 层指标得分矩阵（叶子节点数据）

#### 输出结果：

- `layer4_entropy_weight_results.csv`：包含 4 层指标的熵权法权重结果

### 3. 处理流程

1.  ​**​ 数据准备阶段 ​**​

    - 读取两个核心输入文件：

      - 指标匹配表（定义指标层级关系）

      - 第 4 层指标得分数据（待计算权重的原始数据）

2.  ​**​ 熵权法计算 ​**​

    - 调用`calculate_entropy_weights`函数：

      - 基于指标得分矩阵计算信息熵

      - 根据熵值计算客观权重

      - 参数说明：

        - `indicator_level=4`：指定计算第 4 层指标

        - `verbose=False`：关闭过程日志输出

3.  ​**​ 结果结构化处理 ​**​

    - 调用`merge_entropy_results`函数：

      - 将计算结果与元数据表关联

      - 补充上级指标、指标代码等元信息

      - 按指标等级过滤（保持 level\=4）

4.  ​**​ 结果输出 ​**​

    - 将结构化结果保存为 CSV 文件

    - 使用 UTF-8 with BOM 编码（`utf_8_sig`）确保中文兼容性

### 4. 关键特征

- ​**​ 自动化程度 ​**​：从原始数据到权重结果全自动计算

- ​**​ 参数化设计 ​**​：通过`indicator_level`参数可灵活切换计算层级

- ​**​ 数据追溯 ​**​：结果保留完整的指标元数据（上级指标、代码等）

- ​**​ 输出兼容性 ​**​：采用通用 CSV 格式，编码处理确保多语言支持

### 5. 扩展说明

该模块是 ESG 权重计算流水线中的一环，通常：

1.  先计算最底层（第 4 层）熵权

2.  后续将与其他方法（如 AHP）的权重合并

3.  用于上层指标得分的聚合计算

#

## ==3、main.py==

### **代码流程概览**

1.  ​**​ 数据准备阶段 ​**​

    - 读取 6 个输入文件（指标表、熵权法结果、AHP 结果、四级/三级指标得分、MSCI 数据）

2.  ​**​ 权重处理与得分计算 ​**​

    - 通过`process_weights_and_scores`函数合并熵权法和 AHP 权重，计算组合权重并生成得分

3.  ​**​ 贝叶斯优化目标函数 ​**​

    - 定义`objective`函数，通过多层级权重参数计算 ESG 得分，并与 MSCI 数据对比相关性

4.  ​**​ 超参数搜索 ​**​

    - 使用`gp_minimize`优化 9 个 α 参数（每层 E/S/G 三个支柱的权重混合系数）

5.  ​**​ 输出最优结果 ​**​

    - 打印最优 α 组合和最大相关系数

### **详细步骤说明 ​**​

#### ​**​1. 数据准备 ​**​

|         文件类型         |              路径示例               |       用途       |
| :----------------------: | :---------------------------------: | :--------------: |
|          指标表          |           `ESG_index.csv`           | 定义指标层级关系 |
| 熵权法结果（四级子指标） | `layer4_entropy_weight_results.csv` |   提供客观权重   |
|  AHP 结果（子指标权重）  |     `ahp_analysis_results.csv`      |   提供主观权重   |
| 四级指标得分（叶子节点） |             `ESG4.csv`              |  最底层指标得分  |
|  三级指标得分（父节点）  |        `ESG3_incomplete.csv`        | 部分三级指标得分 |
|      MSCI 基准数据       |             `MSCI.csv`              |  相关性对比基准  |

#### **2. 核心函数：**`process_weights_and_scores`​​

​**​ 功能 ​**​：合并权重 + 计算得分\
​**​ 逻辑分支 ​**​：

- ​**​ 按支柱处理 ​**​（`is_pillar_based=True`）：

  1.  分离 E/S/G 支柱数据

  2.  对每个支柱：

      - 合并熵权法和 AHP 权重（`merge_and_preprocess_weights`）

      - 计算组合权重（`calculate_combined_and_normalized_weights`，使用对应 α 值）

      - 生成当前层级得分（`calculate_scores`）

  3.  合并所有支柱得分

- ​**​ 非支柱处理 ​**​：统一权重合并与得分计算

#### **3. 贝叶斯优化目标函数 ​**​

​**​ 目标 ​**​：最大化 ESG 得分与 MSCI 的斯皮尔曼相关系数平均值\
​**​ 参数 ​**​：9 个 α（α4_E/S/G, α3_E/S/G, α2_E/S/G）\
​**​ 流程 ​**​：

1.  ​**​ 计算三级得分 ​**​：

    - 用 α4_E/S/G 混合四级权重 → 生成完整三级得分（`ESG3_df`）

2.  ​**​ 计算二级得分 ​**​：

    - 三级熵权法权重（`calculate_entropy_weights`）→ 用 α3_E/S/G 混合 → 生成二级得分（`ESG2_df`）

3.  ​**​ 计算一级得分 ​**​：

    - 二级熵权法权重 → 用 α2_E/S/G 混合 → 生成一级得分（`ESG1_df`）

4.  ​**​ 相关性计算 ​**​：

    - 合并 MSCI 与 ESG1 得分，计算 E/S/G 支柱的斯皮尔曼相关系数，取平均值

#### **4. 超参数搜索 ​**​

​**​ 方法 ​**​：高斯过程优化（`gp_minimize`）\
​**​ 搜索空间 ​**​：每个 α ∈ \[0, 1]\
​**​ 迭代次数 ​**​：50 次\
​**​ 优化目标 ​**​：最小化  `-avg_corr`（即最大化相关性）

---

#### ​**​5. 结果输出 ​**​

​**​ 输出内容 ​**​：

1.  最优 α 组合（分四/三/二层）

2.  最大平均斯皮尔曼相关系数\
    ​**​**

    **示例输出 ​**​：

<!---->

    最优alpha组合：第四层α_E=0.123, α_S=0.456, α_G=0.789
    最优alpha组合：第三层α_E=0.234, α_S=0.567, α_G=0.890
    最优alpha组合：第二层α_E=0.345, α_S=0.678, α_G=0.901
    最大斯皮尔曼相关系数：0.85

### **代码结构图 ​**

![](flow_md_files/1741c8e0-1a92-11f0-a4b2-0395a4c3781f.jpeg?v=1&type=image)\\

# 二、重要模块

## ==​1、\*\*熵权法计算模块逻辑说明 ​ \*\*entropy_weight​==

#### A\*\*. 模块功能概述 ​\*\*​

该模块实现 ​**​ 熵权法（Entropy Weight Method）​**​ 的完整计算流程，用于确定多指标体系中各指标的客观权重。核心功能包括：

- ​**​ 数据标准化 ​**​：消除量纲影响

- ​**​ 熵值计算 ​**​：衡量指标离散程度

- ​**​ 权重分配 ​**​：根据信息熵确定指标重要性

- ​**​ 异常处理 ​**​：自动应对数据异常情况

---

#### B\*\*. 核心模块运行逻辑 ​\*\*​

##### ​**​ 模块 1：数据标准化 ​**​

- ​**​ 输入 ​**​：原始指标数据（DataFrame）

- ​**​ 处理逻辑 ​**​：

  1.  对每列数据执行极差标准化（Min-Max Normalization）

  2.  常数列自动设为 0.5（避免除以零错误）

  3.  输出标准化后的数据（值域\[0,1]）

- ​**​ 异常处理 ​**​：

  - 检测并标记常数列

  - 支持过程日志输出（verbose 模式）

##### ​**​ 模块 2：熵值计算 ​**​

- ​**​ 输入 ​**​：标准化后的数据

- ​**​ 处理逻辑 ​**​：

  1.  计算概率矩阵（指标值占比）

  2.  处理零值（替换为极小值 1e-10 避免 log(0)错误）

  3.  计算信息熵（反映指标离散程度）

- ​**​ 异常处理 ​**​：

  - 样本不足时抛出异常

  - 无效熵值自动替换为 1

##### ​**​ 模块 3：权重计算 ​**​

- ​**​ 输入 ​**​：各指标熵值

- ​**​ 处理逻辑 ​**​：

  1.  计算差异系数（1 - 熵值）

  2.  差异系数和为 0 时自动平均分配权重

  3.  正常情况按差异系数比例分配权重

- ​**​ 异常处理 ​**​：

  - 全熵值为 1 时强制平均权重

  - 输出警告日志

##### ​**​ 模块 4：主流程控制 ​**​

- ​**​ 输入 ​**​：指标匹配表 + 原始数据表 + 目标层级

- ​**​ 处理逻辑 ​**​：

  1.  数据预处理（类型转换、空值填充）

  2.  按指标层级建立映射关系

  3.  逐级调用标准化 → 熵值 → 权重计算

  4.  汇总各层级结果

- ​**​ 异常处理 ​**​：

  - 记录失败原因

  - 跳过无效指标列**​**

## **==2、熵权法结果合并模块文档说明 ​==**==merge_entropy_results​​==

#### ​**​A. 模块功能概述 ​**​

该模块用于将熵权法计算结果与指标元数据表进行结构化合并，生成包含完整指标信息的 DataFrame。主要功能包括：

- 结果数据与元数据关联

- 异常结果过滤

- 标准化输出格式

#### ​**​B. 输入输出说明 ​**​

|   ​**​ 项目 ​**​   |                                       ​**​ 说明 ​**​                                       |
| :----------------: | :----------------------------------------------------------------------------------------: |
| ​**​ 输入参数 ​**​ | `results`: 熵权法计算结果字典 `match_df`: 指标匹配表 `indicator_level`: 当前处理的指标等级 |
| ​**​ 输出结果 ​**​ |           结构化 DataFrame 包含：上级指标、指标代码、等级、熵值、权重、支柱信息            |

#### C\*\*. 处理流程逻辑 ​\*\*​

1.  ​**​ 数据预处理阶段 ​**​

    - 强制转换指标代码为字符串类型（确保合并准确性）

    - 初始化空列表存储合并结果

2.  ​**​ 结果字典遍历 ​**​

    - 跳过包含错误信息的结果项（`'error' in data`）

    - 提取有效指标列的熵值和权重数据

    - 保留原始层级关系（上级指标 → 当前指标）

3.  ​**​ 数据结构化转换 ​**​

    - 将列表数据转为 DataFrame

    - 关联指标元数据（通过`指标code`匹配）

    - 补充支柱分类信息（E/S/G）

4.  ​**​ 输出标准化 ​**​

    - 固定列顺序：`[上级指标, 指标code, 指标等级, 熵值, 权重, 支柱]`

    - 自动处理缺失值（`np.nan`填充）

#### D\*\*. 异常处理机制 ​\*\*​

| ​**​ 异常类型 ​**​ |     ​**​ 处理方式 ​**​      |
| :----------------: | :-------------------------: |
|     错误结果项     |       自动跳过不处理        |
|  指标代码匹配失败  | 保留空值（how\='left'合并） |
| 熵值/权重获取失败  |         填充 NaN 值         |

#### ​**​E. 输出数据结构示例 ​**​

| 上级指标 | 指标 code | 指标等级 | 熵值 | 权重 | 支柱 |
| :------: | :-------: | :------: | :--: | :--: | :--: |
|    E1    |    E11    |    3     | 0.85 | 0.35 |  E   |
|    E1    |    E12    |    3     | 0.92 | 0.28 |  E   |
|   ...    |    ...    |   ...    | ...  | ...  | ...  |

#### F\*\*. 设计特点 ​\*\*​

1.  ​**​ 数据完整性 ​**​

    - 保留原始计算结果的所有有效数据

    - 通过左连接确保不丢失任何有效指标

2.  ​**​ 业务可读性 ​**​

    - 输出包含完整的指标层级信息

    - 明确的列命名规范

3.  ​**​ 下游兼容性 ​**​

    - 标准化输出格式便于后续分析

    - 类型一致性保证（字符串/数值型）

### ==3、权重处理与得分计算模块文档说明 ​(\*\*WeightProcessing)​==

#### ​**​A. 模块功能概述 ​**​

该模块实现 ESG 评估中多源权重的融合与得分计算，主要功能包括：

- ​**​ 权重合并 ​**​：整合熵权法（客观）与 AHP（主观）权重

- ​**​ 组合计算 ​**​：可调比例混合两种权重

- ​**​ 层级得分聚合 ​**​：自下而上计算指标得分

- ​**​ 数据合并 ​**​：整合完整评估结果

#### B\*\*. 核心子模块说明 ​\*\*​

##### a.\*\* 权重预处理 (\*\*`merge_and_preprocess_weights`)​​

- ​**​ 输入 ​**​：熵权法权重表 + AHP 权重表

- ​**​ 处理逻辑 ​**​：

  1.  列名标准化（统一权重列命名）

  2.  左连接保留所有熵权法指标

  3.  AHP 权重格式转换（百分比 → 小数）

  4.  缺失值处理（无 AHP 权重时默认赋 1）

- ​**​ 输出 ​**​：包含两套权重的合并表

##### b.\*\* 组合权重计算 (\*\*`calculate_combined_and_normalized_weights`)​​

- ​**​ 输入 ​**​：合并权重表 + 混合比例参数 a1

- ​**​ 处理逻辑 ​**​：

  1.  线性组合：`a1*AHP + (1-a1)*熵权`

  2.  按上级指标分组归一化（权重和\=1）

  3.  零值保护（自动平均分配）

- ​**​ 输出 ​**​：带归一化权重的完整表

##### c.\*\* 得分计算 (\*\*`calculate_scores`)​​

- ​**​ 输入 ​**​：权重表 + 底层指标得分数据

- ​**​ 处理逻辑 ​**​：

  1.  识别所有上级指标

  2.  逐指标加权求和（子指标得分 × 归一化权重）

  3.  异常检测（缺失子指标报警）

- ​**​ 输出 ​**​：证券代码+名称+上级指标得分

##### d.\*\* 结果合并 (\*\*`merge_scores`)​​

- ​**​ 输入 ​**​：新计算结果 + 原有结果

- ​**​ 处理逻辑 ​**​：

  1.  列筛选（保留关键字段）

  2.  全外连接合并数据集

  3.  缺失值填充（补 0 处理）

- ​**​ 输出 ​**​：完整评估结果表

#### C\*\*. 数据处理流程 ​\*\*​

    mermaid

**复制**

    graph LR
        A[熵权法权重] --> C[权重合并]
        B[AHP权重] --> C
        C --> D[组合权重计算]
        D --> E[得分聚合]
        F[底层得分] --> E
        E --> G[结果合并]
        H[原有结果] --> G
        G --> I[最终输出]

#### D\*\*. 关键参数说明 ​\*\*​

| ​**​ 参数 ​**​ | ​**​ 类型 ​**​ | ​**​ 默认值 ​**​ |             ​**​ 作用 ​**​             |
| :------------: | :------------: | :--------------: | :------------------------------------: |
|      `a1`      |     float      |       0.5        | AHP 权重占比（0\=纯熵权法，1\=纯 AHP） |
|     `how`      |      str       |      'left'      |    合并方式（保障熵权法指标不丢失）    |

#### E\*\*. 异常处理机制 ​\*\*​

- ​**​ 权重缺失 ​**​：AHP 缺失时默认权重\=1

- ​**​ 指标缺失 ​**​：跳过不存在得分子指标并报警

- ​**​ 零值保护 ​**​：权重和为零时自动平均分配

- ​**​ 合并填充 ​**​：外连接缺失值填 0

#### F\*\*. 输出数据结构 ​\*\*​

| 证券编码 | 证券名称 | 指标 E1 | 指标 E2 | ... | 指标 G3 |
| :------: | :------: | :-----: | :-----: | :-: | :-----: |
|  600000  | 浦发银行 |  0.85   |  0.72   | ... |  0.91   |

#### G\*\*. 应用场景 ​\*\*​

- ESG 多维度综合评价

- 动态权重敏感性分析（调节 a1 参数）

- 缺失数据下的稳健评估

- 多版本结果比对分析

###
